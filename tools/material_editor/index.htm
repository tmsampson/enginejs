<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<title>Engine Sample: Material Editor</title>

		<!-- EngineJS -->
		<script type="text/javascript" src="enginejs/jquery.js"></script>
		<script type="text/javascript" src="enginejs/engine.js"></script>
		<script type="text/javascript" src="enginejs/resources/libs/jquery-ui.js"></script>
		<script type="text/javascript" src="enginejs/resources/libs/jquery-ui.accordion.multiple.js"></script>
		<script type="text/javascript" src="enginejs/resources/libs/jquery-ui.ion.check/js/ion.checkRadio.min.js"></script>

		<!-- EngineJS App Framework -->
		<link rel='stylesheet' href='enginejs/resources/css/app.css' />
		<link rel="stylesheet" href="enginejs/resources/css/third_party/jquery-ui/jquery-ui.css">
		<link rel="stylesheet" href="enginejs/resources/libs/jquery-ui.ion.check/css/ion.checkRadio.css">
		<link rel="stylesheet" href="enginejs/resources/libs/jquery-ui.ion.check/css/ion.checkRadio.dark.css">

		<!-- Spectrum colour picker -->
		<script src='enginejs/resources/misc/spectrum/spectrum.js'></script>
		<link rel='stylesheet' href='enginejs/resources/misc/spectrum/spectrum.css' />

		<style>
		.editor_section_heading
		{
			margin-top:0px !important;
		}

		.editor_section
		{
			overflow:hidden !important;
		}

		.editor_section h4
		{
			margin: 0px;
			margin-left:-15px;
			margin-bottom:6px;
			padding:0px;
			color : #EEE;
			text-decoration: underline
		}

		.editor_row
		{
			/*border:1px solid yellow;*/
			margin-left:-15px;
			margin-bottom:3px;
			width:370px;
			height:25px;
			overflow:hidden;
		}

		.editor_row .editor_label
		{
			width:130px;
			float:left;
			clear:right;
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select:none;
			user-select:none;
			-o-user-select:none;
			overflow:hidden;
		}

		.editor_row .editor_slider
		{
			width:220px;
			float:left;
			position:relative;
			top: 5px;
		}

		.editor_row input[type="color"]
		{
			height:20px;
		}

		.editor_row input[type="text"]
		{
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
			border-radius: 6px;
			width:220px;
			font-size:12px;
		}
		</style>

		<script language="javascript">
		var resources =
		{
			mat_custom : { file : "mat/wood.mat" }
		};

		var do_resize = function()
		{
			var canvas = document.getElementById("foo");

			var width = canvas.clientWidth;
			var height = canvas.clientHeight;

			Engine.Canvas.Resize(width, height);
		};
		window.addEventListener('resize', do_resize);

		$(document).ready(function()
		{
			var on_load = function()
			{
				// ====================================================================================================================================
				// Misc
				var mtx_trans = mat4.create();
				var model_index = 0;
				var model_rotation = 0;
				var debug_draw_normals = false;
				do_resize();
				Engine.Canvas.EnableContextMenu(false);

				var mat = resources["mat_custom"];
				$("#app_footer").text("Loaded: '" + mat.name + "' [ " + mat.descriptor.file + " ]");
				$("#info_name").val(mat.name);
				$("#info_type").val(mat.type);
				$("#info_path").val(mat.descriptor.file);
				$("#info_shader").val(mat.shader.descriptor.file);

				// ====================================================================================================================================
				// Camera
				var cam = new Engine.Camera.Perspective({ position: [0, 0, -3] });
				cam.AttachHelper(new Engine.Camera.Helper.Orbit(
				{
					look_at : [0, 0, 0],
					radius  : [3, 1.5, 10],
					angles  : [0, 0],
					min_y   : -(Math.PI / 2) - 0.2,
					max_y   : (Math.PI / 2) - 0.1
				}));

				// ====================================================================================================================================
				// Models
				var object_models =
				[
					Engine.Geometry.MakeSphere(),
					Engine.Resources["mdl_cube"]
				];
				var model_index = 0;

				// ====================================================================================================================================
				// Light
				var sun =
				{
					model      : Engine.Geometry.MakeSphere(),
					material   : new Engine.Gfx.Material(),
					position   : [0, 5, 0],
					angle      : 1,	// -90 --> 90 arc
					direction  : [0, -1, 0],
					ambient   : [ 0.6, 0.6, 0.6 ],
					colour     : [0.7, 0.7, 0.7],
					arc_radius : [30, 15],
					arc_lift   : 5
				};
				Engine.Gfx.SetDirectionalLight(sun);

				function update_light()
				{
					// Update light angle
					sun.angle = $("#slider_light_angle").slider("values", 0);

					// Update light position
					sun.position[0] = Math.sin(Engine.Math.DegToRad(sun.angle)) * sun.arc_radius[0];
					sun.position[1] = sun.arc_lift + Math.cos(Engine.Math.DegToRad(sun.angle)) * sun.arc_radius[1];

					// Update light direction
					var len = Math.sqrt((sun.position[0] * sun.position[0]) + (sun.position[1]  * sun.position[1]));
					sun.direction = [ -sun.position[0] / len, -sun.position[1] / len, 0 ];

					// Ambient
					var amb_intensity = $("#slider_amb_intensity").slider("values", 0);
					var amb_colour = Engine.Colour.FromHex($("#amb_colour").val());
					sun.ambient[0] = amb_colour[0] * (amb_intensity / 100);
					sun.ambient[1] = amb_colour[1] * (amb_intensity / 100);
					sun.ambient[2] = amb_colour[2] * (amb_intensity / 100);

					// Directional
					var light_intensity = $("#slider_light_intensity").slider("values", 0);
					var light_colour = Engine.Colour.FromHex($("#light_colour").val());
					sun.colour[0] = light_colour[0] * (light_intensity / 100);
					sun.colour[1] = light_colour[1] * (light_intensity / 100);
					sun.colour[2] = light_colour[2] * (light_intensity / 100);
				};

				var on_render = function()
				{
					// Clear
					Engine.Gfx.Clear(Engine.Colour.Black);
					Engine.Gfx.SetDepthTestMode(Engine.GL.LESS, true);

					// Update & bind camera
					cam.Update();
					Engine.Gfx.BindCamera(cam);

					// Update light
					update_light();

					if(Engine.Keyboard.IsPressed("m", true))
					{
						model_index = (model_index + 1) % object_models.length;
					}

					// Position on grid
					var model = object_models[model_index];
					mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, [0, 0, 0]);

					// Rotate?
					if($("input[name='dorot']").is(":checked") && !debug_draw_normals)
					{
						model_rotation += Engine.Time.delta_s / 3.0;
					}
					mat4.rotate(mtx_trans, mtx_trans, model_rotation, [0, 1, 0]);

					// Draw model
					Engine.Gfx.BindMaterial(resources["mat_custom"]);
					Engine.Gfx.DrawModel(model, mtx_trans, false, false);
				};
				return on_render;
			};

			$("input[name='dorot']").ionCheckRadio();
			$("#menu").menu();
			$("#accordion").accordion({ active : false, multiple: true, collapsible : true, animate: 50, heightStyle: "content" });
			$("#accordion").accordion('option', 'active' , 3); // open info section
			$("#accordion").accordion('option', 'active' , 2); // open debug section
			$("#accordion").accordion('option', 'active' , 1); // open light section
			$("#accordion").accordion('option', 'active' , 0); // open mat section
			$("#slider_amb_intensity").slider({ min : 0, max : 100, value: 50 });
			$("#slider_light_intensity").slider({ min : 0, max : 100, value: 50 });
			$("#slider_light_angle").slider({ min : -90, max : 90, value: 45 });

			Engine.Init(on_load, resources);
		});

		</script>
	</head>

	<body>
		<div class="header row">
			<h2 style="margin:0px; margin-top:0px; margin-left:5px; padding:0px; font-family: Segoe UI,Arial,sans-serif; float:left; width:200px;">Material Editor</h2>
		</div>

		<div class="body row">
			<div class="left col">
				<canvas id="foo" style="margin:0px; width:100%; height:100%; vertical-align: bottom"></canvas>
			</div>
			<div class="right col scroll-y" style="color:blue">
				<div id="accordion">
					<h3 class="editor_section_heading">Material</h3>
					<div>
						<p>
						Mauris mauris ante, blandit et, ultrices a, suscipit eget, quam. Integer
						ut neque. Vivamus nisi metus, molestie vel, gravida in, condimentum sit
						amet, nunc. Nam a nibh. Donec suscipit eros. Nam mi. Proin viverra leo ut
						odio. Curabitur malesuada. Vestibulum a velit eu ante scelerisque vulputate.
						</p>
					</div>

					<h3 class="editor_section_heading">Lighting</h3>
					<div class="editor_section">
						<h4>Ambient Light</h4>
						<div class="editor_row">
							<div class="editor_label">Ambient Colour:</div>
							<input id="amb_colour" type="color" value="#ffffff"/>
						</div>

						<div class="editor_row">
							<div class="editor_label">Ambient Intensity:</div>
							<div id='slider_amb_intensity' class="editor_slider"></div>
						</div>

						<br/>
						<h4>Directional Light</h4>
						<div class="editor_row">
							<div class="editor_label">Light Colour:</div>
							<input id="light_colour" type="color" value="#ffffff"/>
						</div>

						<div class="editor_row">
							<div class="editor_label">Light Intensity:</div>
							<div id='slider_light_intensity' class="editor_slider"></div>
						</div>

						<div class="editor_row">
							<div class="editor_label">Light Angle:</div>
							<div id='slider_light_angle' class="editor_slider"></div>
						</div>
					</div>

					<h3 class="editor_section_heading">Debug</h3>
					<div class="editor_section">
						<div class="editor_row">
							<div class="editor_label">Enable Rotation</div>
							<label><input type="checkbox" name="dorot" value="dd"></label>
						</div>
					</div>

					<h3 class="editor_section_heading">Info</h3>
					<div class="editor_section">
						<div class="editor_row">
							<div class="editor_label">Name:</div>
							<input id="info_name" type="text" disabled/>
						</div>
						<div class="editor_row">
							<div class="editor_label">Type:</div>
							<input id="info_type" type="text" disabled/>
						</div>
						<div class="editor_row">
							<div class="editor_label">Path:</div>
							<input id="info_path" type="text" disabled/>
						</div>
						<div class="editor_row">
							<div class="editor_label">Shader:</div>
							<input id="info_shader" type="text" disabled/>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="app_footer" class="footer row">
			Loading...
		</div>
	</body>
</html>