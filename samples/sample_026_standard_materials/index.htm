<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<title>Engine Sample: Standard material system</title>

		<!-- EngineJS -->
		<script type="text/javascript" src="enginejs/jquery.js"></script>
		<script type="text/javascript" src="enginejs/engine.js"></script>

		<!-- Spectrum colour picker -->
		<script src='enginejs/resources/misc/spectrum/spectrum.js'></script>
		<link rel='stylesheet' href='enginejs/resources/misc/spectrum/spectrum.css' />

		<script language="javascript">
		var resources =
		{
			mat_sponge        : { file : "mat/sponge.mat"},
			mat_plasma        : { file : "mat/plasma.mat"},
			mat_wool          : { file : "mat/wool.mat"},
			mat_shiny_plastic : { file : "mat/shiny-plastic.mat"},
			mat_stone         : { file : "mat/stone.mat"},
			mat_wood          : { file : "mat/wood.mat"},
			mat_snooker_ball  : { file : "mat/snooker-ball.mat"},
			mat_carpet        : { file : "mat/carpet.mat"},
		};

		$(document).ready(function()
		{
			var on_init = function()
			{
				// ====================================================================================================================================
				// Misc
				var mtx_trans = mat4.create();
				var model_index = 0;
				var model_rotate_enabled = false;

				// ====================================================================================================================================
				// Camera
				var cam = new Engine.Camera.Perspective({ position: [0, 4, -5] });
				cam.AttachHelper(new Engine.Camera.Helper.Roam({ forward : [0, 0, 1] }));

				// ====================================================================================================================================
				// Models
				var floor_model = Engine.Resources["ml_floor_tile"];
				var object_models =
				[
					Engine.Geometry.MakeSphere(),
					Engine.Resources["ml_cube"],
					Engine.Geometry.MakePlane({ x_size : 2, z_size : 2}),
				];

				// ====================================================================================================================================
				// Materials
				var floor_material = Engine.Resources["mat_standard_grid_xz_fog_custom"];
				var materials =
				[
					new Engine.Gfx.Material(), // setup below
					resources["mat_sponge"],
					resources["mat_plasma"],
					resources["mat_carpet"],
					resources["mat_shiny_plastic"],
					resources["mat_wool"],
					resources["mat_wood"],
					resources["mat_stone"],
					resources["mat_snooker_ball"],
				];

				// Setup new green material on the fly
				materials[0].SetColour("albedo_colour", [0, 1, 0, 1]);
				materials[0].SetConfig("fresnel_enabled", true);
				materials[0].SetColour("fresnel_colour", [0.8, 1, 0.8, 1]);
				materials[0].SetFloat("fresnel_scale", 0.4);
				materials[0].SetFloat("fresnel_power", 2);

				// ====================================================================================================================================
				// Light
				var sun =
				{
					model     : Engine.Geometry.MakeSphere(),
					material  : new Engine.Gfx.Material(),
					pos       : [0, 5, 0],
					angle     : 0,	// 0 = straight down y-axis
					direction : [ 0, -1, 0 ],
					colour    : [ 0.4, 0.4, 0.4 ],
				};

				function update_light()
				{
					sun.angle += Engine.Mouse.GetWheelDelta() / 20;

					// Process gamepad input
					var gamepad = Engine.Gamepad.Pads[0];
					if(gamepad)
					{
						sun.angle += gamepad.IsPressed("lb")? -1 : (gamepad.IsPressed("rb")? 1 : 0);

						if(gamepad.IsPressed("lt"))
						{
							sun.colour[0] -= 0.01;
							sun.colour[1] -= 0.01;
							sun.colour[2] -= 0.01;
						}
						if(gamepad.IsPressed("rt"))
						{
							sun.colour[0] += 0.01;
							sun.colour[1] += 0.01;
							sun.colour[2] += 0.01;
						}
					}
				};

				function draw_light()
				{
					// Draw light as sphere
					mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, sun.pos);
					mat4.scale(mtx_trans, mtx_trans, [0.2, 0.2, 0.2]);
					Engine.Gfx.BindMaterial(sun.material, sun)
					Engine.Gfx.SetShaderProperty("u_trans_world", mtx_trans, Engine.Gfx.SP_MATRIX4);
					Engine.Gfx.DrawModel(sun.model);

					// Draw light basis
					Engine.Debug.DrawArrow3D(cam, sun.pos, [sun.pos[0] + 3, sun.pos[1],     sun.pos[2]],     Engine.Colour.Red, 1);
					Engine.Debug.DrawArrow3D(cam, sun.pos, [sun.pos[0],     sun.pos[1] + 3, sun.pos[2]],     Engine.Colour.Green, 1);
					Engine.Debug.DrawArrow3D(cam, sun.pos, [sun.pos[0],     sun.pos[1],     sun.pos[2] + 3], Engine.Colour.Blue, 1);

					// Draw light angle
					mat4.fromRotation(mtx_trans, Engine.Math.DegToRad(sun.angle), [0, 0, -1]);
					vec3.transformMat4(sun.direction, [0, -1, 0], mtx_trans);
					var lp = [ sun.pos[0], sun.pos[1], sun.pos[2] ];
					Engine.Debug.DrawArrow3D(cam, lp, [lp[0] + (sun.direction[0] * 3),     lp[1]+ (sun.direction[1] * 3),     lp[2]+ (sun.direction[2] * 3)], Engine.Colour.Orange, 1);
					lp[0] = sun.pos[0] + 0.2;
					Engine.Debug.DrawArrow3D(cam, lp, [lp[0] + (sun.direction[0] * 3),     lp[1]+ (sun.direction[1] * 3),     lp[2]+ (sun.direction[2] * 3)], Engine.Colour.Orange, 1);
					lp[0] = sun.pos[0] - 0.2;
					Engine.Debug.DrawArrow3D(cam, lp, [lp[0] + (sun.direction[0] * 3),     lp[1]+ (sun.direction[1] * 3),     lp[2]+ (sun.direction[2] * 3)], Engine.Colour.Orange, 1);
				};

				var on_render = function(info)
				{
					// Clear
					Engine.Gfx.Clear(Engine.Colour.Black);
					Engine.Gfx.SetDepthTestMode(Engine.GL.LESS, true);

					// Update & bind camera
					cam.Update(info);
					Engine.Gfx.BindCamera(cam);

					// Update light
					update_light();
					draw_light();

					// Process gamepad input
					gamepad = Engine.Gamepad.Pads[0];
					if(gamepad)
					{
						if(gamepad.IsPressed("a", true))
						{
							model_index = (model_index + 1) % object_models.length;
						}
						if(gamepad.IsPressed("b", true))
						{
							model_rotate_enabled = !model_rotate_enabled;
						}
					}

					// Draw floor
					mat4.scale(mtx_trans, Engine.Math.IdentityMatrix, [100, 0, 100]);
					Engine.Gfx.BindMaterial(floor_material, sun);
					Engine.Gfx.SetShaderProperty("u_trans_world", mtx_trans, Engine.Gfx.SP_MATRIX4);
					Engine.Gfx.DrawModel(floor_model);

					// Draw object_models
					var mat_index = 0;
					for(var i = -10; i <= 10; ++i)
					{
						for(var j = -10; j <= 10; ++j)
						{
							// Bind material
							Engine.Gfx.BindMaterial(materials[mat_index++ % materials.length], sun);

							// Position on grid
							mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, [i * 3, 1.2, j * 3]);

							// Rotate?
							if(model_rotate_enabled)
							{
								mat4.rotate(mtx_trans, mtx_trans, info.elapsed_s / 3.0, [0, 1, 0]);
							}

							// Bind transform
							Engine.Gfx.SetShaderProperty("u_trans_world", mtx_trans, Engine.Gfx.SP_MATRIX4);

							// Draw model
							Engine.Gfx.DrawModel(object_models[model_index]);
						}
					}
				};
				return on_render;
			};
			Engine.Init(on_init, resources);
		});
		</script>
	</head>

	<body>
		<canvas width="1024" height="800">
	</body>
</html>