<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<title>Engine Sample: Legacy material system</title>

		<!-- EngineJS -->
		<script type="text/javascript" src="enginejs/jquery.js"></script>
		<script type="text/javascript" src="enginejs/engine.js"></script>

		<!-- Spectrum colour picker -->
		<script src='enginejs/resources/misc/spectrum/spectrum.js'></script>
		<link rel='stylesheet' href='enginejs/resources/misc/spectrum/spectrum.css' />

		<script language="javascript">
		var resources =
		{
			tx_stone_albedo : { file : "img/stone-albedo.jpg" },
			tx_stone_normal : { file : "img/stone-normal.jpg" },
		};

		// ====================================================================================================================================
		// Misc
		// ====================================================================================================================================
		var cam = null;
		var mtx_trans = null;

		// ====================================================================================================================================
		// Models
		// ====================================================================================================================================
		var model_floor = null;
		var models = null;

		// ====================================================================================================================================
		// Shader programs
		// ====================================================================================================================================
		var program_floor
		var program_ambient
		var program_diffuse
		var program_specular
		var program_white_unlit

		// ====================================================================================================================================
		// Light update / render
		// ====================================================================================================================================
		var light_pos = [0, 5, 0];
		function update_light(info)
		{
			var light_move_speed = 0.1;
			if(Engine.Keyboard.IsPressed("w"))     { light_pos[2] -= light_move_speed; }
			if(Engine.Keyboard.IsPressed("s"))     { light_pos[2] += light_move_speed; }
			if(Engine.Keyboard.IsPressed("left"))  { light_pos[0] -= light_move_speed; }
			if(Engine.Keyboard.IsPressed("right")) { light_pos[0] += light_move_speed; }
			if(Engine.Keyboard.IsPressed("up"))    { light_pos[1] += light_move_speed; }
			if(Engine.Keyboard.IsPressed("down"))  { light_pos[1] -= light_move_speed; }
			draw_light(light_pos);
		};

		function draw_light(light_pos)
		{
			// Draw light as sphere
			mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, light_pos);
			mat4.scale(mtx_trans, mtx_trans, [0.3, 0.3, 0.3]);
			Engine.Gfx.BindShaderProgram(program_white_unlit);
			Engine.Gfx.SetShaderConstant("u_trans_world", mtx_trans, Engine.Gfx.SC_MATRIX4);
			Engine.Gfx.SetShaderConstant("u_colour", Engine.Colour.White, Engine.Gfx.SC_COLOUR);
			Engine.Gfx.DrawModel(models[2]);

			// Draw light basis
			Engine.Debug.DrawArrow3D(cam, light_pos, [light_pos[0] + 3, light_pos[1],     light_pos[2]],     Engine.Colour.Red, 1);
			Engine.Debug.DrawArrow3D(cam, light_pos, [light_pos[0],     light_pos[1] + 3, light_pos[2]],     Engine.Colour.Green, 1);
			Engine.Debug.DrawArrow3D(cam, light_pos, [light_pos[0],     light_pos[1],     light_pos[2] + 3], Engine.Colour.Blue, 1);
		};

		// ====================================================================================================================================
		// Colour picker helpers
		// ====================================================================================================================================
		function colour_from_picker_rgb(picker_selector)
		{
			var raw_value = $(picker_selector).spectrum("get").toRgb();
			return [raw_value.r /= 255, raw_value.g /= 255, raw_value.b /= 255 ];
		};

		function colour_from_picker_rgba(picker_selector)
		{
			var raw_value = $(picker_selector).spectrum("get").toRgb();
			return [raw_value.r /= 255, raw_value.g /= 255, raw_value.b /= 255, raw_value.a /= 255 ];
		};

		$(document).ready(function()
		{
			var on_init = function()
			{
				mtx_trans = mat4.create();

				// Setup models
				model_floor = Engine.Resources["ml_floor_tile"];
				models =
				[
					Engine.Resources["ml_cube"],
					Engine.Geometry.MakePlane({ x_size : 2, z_size : 2}),
					Engine.Geometry.MakeSphere(),
				];

				// Compile shaders
				program_floor       = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed"],
				                                                     Engine.Resources["fs_grid_xz_fog"]);
				program_ambient     = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed_uv_normals"],
				                                                     Engine.Resources["fs_legacy_ambient"]);
				program_diffuse     = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed_uv_normals"],
				                                                     Engine.Resources["fs_legacy_diffuse"]);
				program_specular    = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed_uv_normals"],
				                                                     Engine.Resources["fs_legacy_specular"]);
				program_white_unlit = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed"],
				                                                         Engine.Resources["fs_unlit_colour"]);

				// Setup roam cam
				cam = new Engine.Camera.Perspective({ position: [0, 10, -10] });
				cam.AttachHelper(new Engine.Camera.Helper.Roam({ forward : [0, -1, 1] }));

				// Setup UI colour pickers
				var config = { showInput: false, showButtons: false, preferredFormat: "rgb" };
				$("#sun_ambient").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#sun_specular").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#sun_diffuse").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#material_colour").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#material_specular").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#sun_ambient").spectrum("set", "rgba 70 70 70 255");
				$("#sun_diffuse").spectrum("set", "rgba 255 255 255 255");
				$("#sun_specular").spectrum("set", "rgba 255 255 255 255");
				$("#material_colour").spectrum("set", "rgba 255 255 255 255");
				$("#material_specular").spectrum("set", "rgba 255 255 255 255");

				// Setup UI sliders
				$("#material_shininess").slider({ label : "Shininess", value: 50, min: 1,   max: 100,   step: 1 })

				var on_render = function(info)
				{
					// Clear
					Engine.Gfx.Clear(Engine.Colour.Black);
					Engine.Gfx.SetDepthTestMode(Engine.GL.LESS, true);

					// Update & bind camera
					cam.Update(info);
					Engine.Gfx.BindCamera(cam);

					// Update light
					update_light(info);

					// Draw floor
					mat4.scale(mtx_trans, Engine.Math.IdentityMatrix, [100, 0, 100]);
					Engine.Gfx.BindShaderProgram(program_floor);
					Engine.Gfx.SetShaderConstant("u_trans_world", mtx_trans, Engine.Gfx.SC_MATRIX4);
					Engine.Gfx.DrawModel(model_floor);

					// Draw models
					var model_index = 0;
					//for(var i = -5; i <= 5; ++i)
					{
						//for(var j = -5; j <= 5; ++j)
						{
							// Pick model
							//var model = models[model_index++ % models.length];
							var i = 0; var j = 0;
							var model = models[2];

							// Position on grid and rotate
							mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, [0, 2, 0]);
							//mat4.rotate(mtx_trans, mtx_trans, info.elapsed_s, [1, 1, 1]);

							// Set shader
							var shader_mode = $('select').val();
							if(shader_mode == "ambient")  { Engine.Gfx.BindShaderProgram(program_ambient); }
							if(shader_mode == "diffuse")  { Engine.Gfx.BindShaderProgram(program_diffuse); }
							if(shader_mode == "specular") { Engine.Gfx.BindShaderProgram(program_specular); }

							// Bind transform
							Engine.Gfx.SetShaderConstant("u_trans_world", mtx_trans, Engine.Gfx.SC_MATRIX4);

							// Bind global "sun" params
							Engine.Gfx.SetShaderConstant("u_sun_ambient", colour_from_picker_rgb("#sun_ambient"), Engine.Gfx.SC_VEC3);
							if(shader_mode == "diffuse" || shader_mode == "specular")
							{
								Engine.Gfx.SetShaderConstant("u_sun_diffuse", colour_from_picker_rgb("#sun_diffuse"), Engine.Gfx.SC_VEC3);
								Engine.Gfx.SetShaderConstant("u_sun_dir", [0.71, -0.71, 0], Engine.Gfx.SC_VEC3);
							}
							if(shader_mode == "specular")
							{
								Engine.Gfx.SetShaderConstant("u_sun_specular", colour_from_picker_rgb("#sun_specular"), Engine.Gfx.SC_VEC3);
							}

							// Bind material properties
							Engine.Gfx.SetShaderConstant("u_material_colour", colour_from_picker_rgba("#material_colour"), Engine.Gfx.SC_VEC4);
							if(shader_mode == "specular")
							{
								Engine.Gfx.SetShaderConstant("u_material_specular", colour_from_picker_rgba("#material_specular"), Engine.Gfx.SC_VEC4);
								Engine.Gfx.SetShaderConstant("u_material_shininess", $("#material_shininess").slider("value"), Engine.Gfx.SC_FLOAT);
							}

							// Bind textures
							Engine.Gfx.BindTexture(resources["tx_stone_albedo"], 0, "u_material_tx_albedo");

							// Draw model
							Engine.Gfx.DrawModel(model);

							// Draw normals
							var verts = model.model_data.primitives[0].vertex_buffers[0].stream;
							var normals = model.model_data.primitives[0].vertex_buffers[1].stream;
							var tangents = model.model_data.primitives[0].vertex_buffers[4].stream;
							for(var x= 0; x < verts.length; x +=3)
							{
								var v0 = verts[x + 0];
								var v1 = verts[x + 1] + 2;
								var v2 = verts[x + 2];

								if($('#cb_show_normals').is(":checked"))
								{
									var n0 = normals[x + 0];
									var n1 = normals[x + 1];
									var n2 = normals[x + 2];
									Engine.Debug.DrawArrow3D(cam, [v0, v1, v2], [v0 + n0, v1 + n1, v2 + n2], Engine.Colour.Red, 1);
								}
								
								if($('#cb_show_tangents').is(":checked"))
								{
									var t0 = tangents[x + 0];
									var t1 = tangents[x + 1];
									var t2 = tangents[x + 2];
									Engine.Debug.DrawArrow3D(cam, [v0, v1, v2], [v0 + t0, v1 + t1, v2 + t2], Engine.Colour.Blue, 1);
								}
							}
						}
					}
				};
				return on_render;
			};
			Engine.Init(on_init, resources);
		});
		</script>
	</head>

	<body>
		<table style="width:100%">
			<tr>
				<td style="width:1000px;vertical-align:top"><canvas width="800" height="600"></canvas></td>
				<td id="param_editor_window" style="background-color:white;padding:20px;vertical-align:top">
					<h4>Lighting Model</h4>
					<select>
						<option value="specular">specular</option>
						<option value="ambient">ambient</option>
						<option value="diffuse">diffuse</option>
					</select>

					<h4>Debug</h4>
					Show normals: <input type="checkbox" id="cb_show_normals" id="" />
					Show tangents: <input type="checkbox" id="cb_show_tangents" id="" />

					<h4>Material Properties</h4>
					Material colour<br/>
					<input type="text" id="material_colour"/></input><br/>
					Material specular<br/>					
					<input type="text" id="material_specular"/></input><br/>
					Shininess:
					<div id="material_shininess" style="width:200px"/>
					<br/>

					<h4>Global Light Properties</h4>
					Sun Ambient<br/>
					<input type="text" id="sun_ambient"></input><br/>
					Sun Diffuse<br/>
					<input type="text" id="sun_diffuse"></input><br/>
					Sun Specular<br/>
					<input type="text" id="sun_specular"></input>
				</td>
			</tr>
		</table>
	</body>
</html>