<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<title>Engine Sample: Legacy material system</title>

		<!-- EngineJS -->
		<script type="text/javascript" src="enginejs/jquery.js"></script>
		<script type="text/javascript" src="enginejs/engine.js"></script>

		<!-- Spectrum colour picker -->
		<script src='enginejs/resources/misc/spectrum/spectrum.js'></script>
		<link rel='stylesheet' href='enginejs/resources/misc/spectrum/spectrum.css' />

		<script language="javascript">
		var resources =
		{
			tx_stone_albedo : { file : "img/stone-albedo.jpg" },
			tx_stone_normal : { file : "img/stone-normal.jpg" },
		};

		$(document).ready(function()
		{
			var on_init = function()
			{
				var mtx_trans = mat4.create();
				var mtx_stone_normal = mat3.create();

				var model_floor = Engine.Resources["ml_floor_tile"];
				var models =
				[
					Engine.Resources["ml_cube"],
					Engine.Geometry.MakePlane({ x_size : 2, z_size : 2}),
					Engine.Geometry.MakeSphere(),
				];

				// Compile shaders
				var program_floor       = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed"],
				                                                         Engine.Resources["fs_grid_xz_fog"]);
				var program_ambient     = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed_uv_normals"],
				                                                         Engine.Resources["fs_legacy_ambient"]);
				var program_diffuse     = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed_uv_normals"],
				                                                         Engine.Resources["fs_legacy_diffuse"]);
				var program_specular    = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed_uv_normals"],
				                                                         Engine.Resources["fs_legacy_specular"]);
				var program_white_unlit = Engine.Gfx.CreateShaderProgram(Engine.Resources["vs_general_transformed"],
				                                                         Engine.Resources["fs_unlit_colour"]);

				// Setup roam cam
				var cam = new Engine.Camera.Perspective({ position: [0, 10, -10] });
				cam.AttachHelper(new Engine.Camera.Helper.Roam({ forward : [0, -1, 1] }));

				// Setup UI colour pickers
				var config = { flat: true, showInput: false, showButtons: false, preferredFormat: "rgb" };
				$("#sun_ambient").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#sun_specular").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#sun_diffuse").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#material_colour").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#material_specular").spectrum($.extend({}, config, { move : function(color) { } }));
				$("#sun_ambient").spectrum("set", "rgba 70 70 70 255");
				$("#sun_diffuse").spectrum("set", "rgba 255 255 255 255");
				$("#sun_specular").spectrum("set", "rgba 255 255 255 255");
				$("#material_colour").spectrum("set", "rgba 255 255 255 255");
				$("#material_specular").spectrum("set", "rgba 255 255 255 255");

				// Setup UI sliders
				$("#material_shininess").slider({ label : "Shininess", value: 50, min: 1,   max: 100,   step: 1 })

				var draw_light = function(light_pos)
				{
					// Draw light as sphere
					mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, light_pos);
					mat4.scale(mtx_trans, mtx_trans, [0.3, 0.3, 0.3]);
					Engine.Gfx.BindShaderProgram(program_white_unlit);
					Engine.Gfx.SetShaderConstant("u_trans_world", mtx_trans, Engine.Gfx.SC_MATRIX4);
					Engine.Gfx.SetShaderConstant("u_colour", Engine.Colour.White, Engine.Gfx.SC_COLOUR);
					Engine.Gfx.DrawModel(models[2]);

					// Draw light basis
					Engine.Debug.DrawArrow3D(cam, light_pos, [light_pos[0] + 3, light_pos[1],     light_pos[2]],     Engine.Colour.Red, 1);
					Engine.Debug.DrawArrow3D(cam, light_pos, [light_pos[0],     light_pos[1] + 3, light_pos[2]],     Engine.Colour.Green, 1);
					Engine.Debug.DrawArrow3D(cam, light_pos, [light_pos[0],     light_pos[1],     light_pos[2] + 3], Engine.Colour.Blue, 1);
				};

				var light_pos = [0, 5, 0];
				var update_light = function(info)
				{
					var light_move_speed = 0.1;
					if(Engine.Keyboard.IsPressed("w"))     { light_pos[2] -= light_move_speed; }
					if(Engine.Keyboard.IsPressed("s"))     { light_pos[2] += light_move_speed; }
					if(Engine.Keyboard.IsPressed("left"))  { light_pos[0] -= light_move_speed; }
					if(Engine.Keyboard.IsPressed("right")) { light_pos[0] += light_move_speed; }
					if(Engine.Keyboard.IsPressed("up"))    { light_pos[1] += light_move_speed; }
					if(Engine.Keyboard.IsPressed("down"))  { light_pos[1] -= light_move_speed; }
					draw_light(light_pos);
				};

				var colour_from_picker_rgb = function (picker_selector)
				{
					var raw_value = $(picker_selector).spectrum("get").toRgb();
					return [raw_value.r /= 255, raw_value.g /= 255, raw_value.b /= 255 ];
				};

				var colour_from_picker_rgba = function (picker_selector)
				{
					var raw_value = $(picker_selector).spectrum("get").toRgb();
					return [raw_value.r /= 255, raw_value.g /= 255, raw_value.b /= 255, raw_value.a /= 255 ];
				};

				var on_render = function(info)
				{
					// Clear
					Engine.Gfx.Clear(Engine.Colour.Black);
					Engine.Gfx.SetDepthTestMode(Engine.GL.LESS, true);

					// Update & bind camera
					cam.Update(info);
					Engine.Gfx.BindCamera(cam);

					// Update light
					update_light(info);

					// Draw floor
					mat4.scale(mtx_trans, Engine.Math.IdentityMatrix, [100, 0, 100]);
					Engine.Gfx.BindShaderProgram(program_floor);
					Engine.Gfx.SetShaderConstant("u_trans_world", mtx_trans, Engine.Gfx.SC_MATRIX4);
					Engine.Gfx.DrawModel(model_floor);

					// Draw models
					var model_index = 0;
					for(var i = -5; i <= 5; ++i)
					{
						for(var j = -5; j <= 5; ++j)
						{
							// Pick model
							var model = models[model_index++ % models.length];

							// Position on grid and rotate
							mat4.translate(mtx_trans, Engine.Math.IdentityMatrix, [i * 3, 1.2, j * 3]);
							mat4.rotate(mtx_trans, mtx_trans, info.elapsed_s, [1, 1, 1]);

							// Set shader
							var shader_mode = $('select').val();
							if(shader_mode == "ambient")  { Engine.Gfx.BindShaderProgram(program_ambient); }
							if(shader_mode == "diffuse")  { Engine.Gfx.BindShaderProgram(program_diffuse); }
							if(shader_mode == "specular") { Engine.Gfx.BindShaderProgram(program_specular); }

							// Bind transform
							Engine.Gfx.SetShaderConstant("u_trans_world", mtx_trans, Engine.Gfx.SC_MATRIX4);

							// Bind global "sun" params
							Engine.Gfx.SetShaderConstant("u_sun_ambient", colour_from_picker_rgb("#sun_ambient"), Engine.Gfx.SC_VEC3);
							if(shader_mode == "diffuse" || shader_mode == "specular")
							{
								Engine.Gfx.SetShaderConstant("u_sun_diffuse", colour_from_picker_rgb("#sun_diffuse"), Engine.Gfx.SC_VEC3);
								Engine.Gfx.SetShaderConstant("u_sun_dir", [0.71, -0.71, 0], Engine.Gfx.SC_VEC3);
							}
							if(shader_mode == "specular")
							{
								Engine.Gfx.SetShaderConstant("u_sun_specular", colour_from_picker_rgb("#sun_specular"), Engine.Gfx.SC_VEC3);
							}

							// Bind material properties
							Engine.Gfx.SetShaderConstant("u_material_colour", colour_from_picker_rgba("#material_colour"), Engine.Gfx.SC_VEC4);
							if(shader_mode == "specular")
							{
								Engine.Gfx.SetShaderConstant("u_material_specular", colour_from_picker_rgba("#material_specular"), Engine.Gfx.SC_VEC4);
								Engine.Gfx.SetShaderConstant("u_material_shininess", $("#material_shininess").slider("value"), Engine.Gfx.SC_FLOAT);
							}

							// Bind textures
							Engine.Gfx.BindTexture(resources["tx_stone_albedo"], 0, "u_material_tx_albedo");

							// Draw model
							Engine.Gfx.DrawModel(model);
						}
					}
				};
				return on_render;
			};
			Engine.Init(on_init, resources);
		});
		</script>
	</head>

	<body>
		<table style="width:100%">
			<tr>
				<td style="width:1000px;vertical-align:top"><canvas width="800" height="600"></canvas></td>
				<td id="param_editor_window" style="background-color:white;padding:20px;vertical-align:top">
					<h2>Lighting Model</h2>
					<select>
						<option value="ambient">ambient</option>
						<option value="diffuse">diffuse</option>
						<option value="specular">specular</option>
					</select>

					<h2>Material Properties</h2>
					Material colour<br/>
					<div id="material_colour"/></div><br/>
					Material specular<br/>					
					<div id="material_specular"/></div><br/>
					Shininess:
					<div id="material_shininess" style="width:200px"/>
					<br/>

					<h2>Global Light Properties</h2>
					Sun Ambient<br/>
					<div id="sun_ambient"></div><br/>
					Sun Diffuse<br/>
					<div id="sun_diffuse"></div><br/>
					Sun Specular<br/>
					<div id="sun_specular"></div>
				</td>
			</tr>
		</table>
	</body>
</html>